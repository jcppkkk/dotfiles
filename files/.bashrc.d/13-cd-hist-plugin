#!/bin/bash

export cdhist_file="$HOME/.cd_history"

touch "$cdhist_file"

IFS=:
if [[ ! ":${chpwd_functions[*]}:" =~ :append_cdhist: ]]; then
    chpwd_functions+=(append_cdhist)
fi
unset IFS

# build sed args to reverse path to home links
readarray -t home_links < <(find ~/ -maxdepth 1 -type l -xtype d -print)
sed_args=()
for link in "${home_links[@]}"; do
    target=$(readlink "$link")
    sed_args+=(-e "s@^$target@$link@")
done

append_cdhist() {
    echo "$PWD" | sed "${sed_args[@]}" -e "s@^$HOME@~@" >>"$cdhist_file"
}

cd_widget() {
    cd_target="$(percol --prompt-bottom --result-bottom-up --reverse "$cdhist_file")"
    if ((${#cd_target} != 0)); then
        # shellcheck disable=SC2164
        cd "${cd_target/#\~/$HOME}"
    fi
    (
        sed "${sed_args[@]}" -e "s@^$HOME@~@" "$cdhist_file" \
            | while read -r line; do
                timeout 0.5 test -d "${line/#\~/$HOME}" && echo "$line"
            done \
            | tac \
            | awk '!x[$0]++' \
            | head -n 300 \
            | tac \
            | sponge "$cdhist_file" &
    )
}

# if this is interactive shell, then bind hstr to Alt-s (for Vi mode check doc)
if [[ $- =~ .*i.* ]]; then bind -x '"\es": "cd_widget"'; fi
