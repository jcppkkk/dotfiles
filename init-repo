#!/bin/bash

# ==============================================================================
# Clean up gitconfig filter
# ==============================================================================
clean_gitconfig_filter_fn() {
    # Create a temporary file
    tmpfile=$(mktemp)

    # Save stdin to temporary file
    cat >"$tmpfile"

    # Process the file - remove scalar and maintenance sections
    if [[ -s "$tmpfile" ]]; then
        # Find and remove scalar section
        scalar_keys=$(git config --file "$tmpfile" --get-regexp "scalar\.")
        if [[ -n "$scalar_keys" ]]; then
            git config --file "$tmpfile" --remove-section scalar
        fi

        # Find and remove maintenance section
        maintenance_keys=$(git config --file "$tmpfile" --get-regexp "maintenance\.")
        if [[ -n "$maintenance_keys" ]]; then
            git config --file "$tmpfile" --remove-section maintenance
        fi

        # Output the cleaned file to stdout
        cat "$tmpfile"
    fi

    # Remove temporary file
    rm -f "$tmpfile"
}

# Define the clean filter
gitconfig_clean_filter="env -i bash -c '$(declare -f clean_gitconfig_filter_fn); clean_gitconfig_filter_fn'"

# Set up the git filter if not already configured
if [[ $(git config --get filter.sanitize-gitconfig.clean) != "$gitconfig_clean_filter" ]]; then
    echo "Configuring git filter for files/.gitconfig"
    git config filter.sanitize-gitconfig.clean "$gitconfig_clean_filter"
fi

# Set up gitattributes if needed
if ! grep "^files/.gitconfig" .gitattributes &>/dev/null; then
    echo "files/.gitconfig filter=sanitize-gitconfig" >>.gitattributes
fi
