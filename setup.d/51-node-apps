#!/bin/bash
# vim: set et fenc=utf-8 ff=unix sts=4 sw=4 ts=8 :
common_lib="$(dirname "$(readlink -f "$0")")/common-lib"
if [[ -f "$common_lib" ]]; then
    # shellcheck source=common-lib
    . "$common_lib"
else
    echo "Cannot find common-lib."
    exit 1
fi

# Ensure mise is available
export PATH="$HOME/.local/bin:$PATH"
if ! command -v mise &>/dev/null; then
    fail "mise not found, skipping node apps installation"
    exit 0
fi

eval "$(mise activate bash)" || {
    fail "Failed to activate mise"
    exit 0
}

mise use --global node@latest node@20 || true

mise use -g npm:@openai/codex || true
mise exec node@latest -- npm update -g npm || change "npm update failed (may be I/O error)"
mise exec node@latest -- npm install -g @commitlint/{cli,config-conventional,load} opencommit || change "npm install failed (may be I/O error)"
mise exec node@latest -- npm install -g task-master-ai || change "npm install task-master-ai failed (may be I/O error)"
