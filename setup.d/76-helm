#!/bin/bash
# vim: set et fenc=utf-8 ff=unix sts=4 sw=4 ts=8 :
common_lib="$(dirname "$(readlink -f "$0")")/common-lib"
if [[ -f "$common_lib" ]]; then
    # shellcheck source=common-lib
    . "$common_lib"
else
    echo "Cannot find common-lib."
    exit 1
fi

install_helm_direct() {
    change "Installing helm via direct download"
    HELM_VERSION=$(curl -fsSL https://api.github.com/repos/helm/helm/releases/latest | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
    ARCH=$(dpkg --print-architecture)
    case $ARCH in
        amd64) HELM_ARCH="amd64" ;;
        arm64) HELM_ARCH="arm64" ;;
        armhf) HELM_ARCH="arm" ;;
        *) fail "Unsupported architecture: $ARCH"; return 1 ;;
    esac
    curl -fsSL "https://get.helm.sh/helm-${HELM_VERSION}-linux-${HELM_ARCH}.tar.gz" | tar -xz
    sudo mv linux-${HELM_ARCH}/helm /usr/local/bin/helm
    rm -rf linux-${HELM_ARCH}
    pass "helm installed via direct download"
}

# Try to install via apt repository first
if command -v helm &>/dev/null; then
    pass "helm is already installed"
else
    # Try apt repository method
    if [[ ! -f /usr/share/keyrings/helm.gpg ]]; then
        ensure_pkg curl apt-transport-https
        if curl -fsSL https://baltocdn.com/helm/signing.asc | gpg --dearmor | sudo tee /usr/share/keyrings/helm.gpg >/dev/null 2>&1; then
            REPO_LINE="deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/helm.gpg] https://baltocdn.com/helm/stable/debian/ all main"
            if ! grep -q -F "$REPO_LINE" /etc/apt/sources.list.d/helm-stable-debian.list 2>/dev/null; then
                echo "$REPO_LINE" | sudo tee /etc/apt/sources.list.d/helm-stable-debian.list >/dev/null
            fi
            apt-update-smart
            if ensure_pkg helm 2>/dev/null; then
                pass "helm installed via apt repository"
            else
                change "apt repository failed, trying direct install"
                install_helm_direct
            fi
        else
            change "Failed to add helm repository, trying direct install"
            install_helm_direct
        fi
    else
        apt-update-smart
        if ensure_pkg helm 2>/dev/null; then
            pass "helm installed via apt repository"
        else
            change "apt repository failed, trying direct install"
            install_helm_direct
        fi
    fi
fi
